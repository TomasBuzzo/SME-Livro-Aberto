{% extends 'regionalizacao/base.html'  %}
{% load static %}
{% load humanize %}
{% load l10n %}

{% block title %}Regionalização{% endblock %}

{%block header %}
  <h1>Regionalização</h1>
  <p>Saiba onde está o orçamento da educação de São Paulo</p>
  {% include '_header_nav.html' with last_update_header='Última atualização em: ' about='regionalizacao:saiba_mais' methodology='regionalizacao:metodologia' %}
{% endblock %}
{%block sections %}
  <section id="mapa">
    <div class="wrapper">
        <p>Clique sobre o mapa de São Paulo e utilize os controles abaixo para explorar a distribuição de despesas e transferências nas regiões, Diretorias Regionais e unidades da Educação municipal.</p>
      <form action="#mapa" method="get" class="query">
        <div class="form-item switch">
          <input type="checkbox" name="rede" id="executed-switch" value="CON" {% if filter_form.rede.value == 'CON' %}checked{% endif %}>
          <label for="executed-switch">Unidades parceiras</label>
          <label for="executed-switch">Unidades diretas</label>
        </div>
          <div class="form-item">
            <select id="{{ filter_form.year.id_for_label }}" name="{{ filter_form.year.name }}">
                {% localize off %}
                {% for value, label in filter_form.year.field.choices %}
                    <option value="{{ value }}"
                            {% if value|unlocalize == filter_form.year.value|unlocalize %}selected{% endif %}>{{ label }}

                    </option>
                {% endfor %}
                {% endlocalize %}
            </select>
          </div>
        <input class="submit" type="submit" value="Filtrar" name="go">
      </form>
      {% include '_breadcrumb.html' with breadcrumb=breadcrumb anchor='mapa' %}
      <div class="chart">
      <svg class="map-container">
          <g class="map">
          </g>
          <g class="focus">
          {% if filter_form.distrito.value %}
              <path data-id="{{filter_form.distrito.value}}" class="active"></path>
          {% else %}
          {% for place in places %}
              <a href="{{place.url}}#mapa">
              <path data-id="{% if place.code %}{{place.code}}{% else %}{{place.name}}{% endif%}"></path>
              </a>
          {% endfor %}
          {% endif%}
          </g>
          {% if filter_form.distrito.value %}
          <g class="schools">
          {% for place in places %}
              <a href="{{place.url}}#mapa">
                  <use
                 {% if place.code == filter_form.escola.value %}
                 xlink:href="{% static 'regionalizacao/img/marker-active.svg' %}#marker"
                 {% else %}
                 xlink:href="{% static 'regionalizacao/img/marker.svg' %}#marker"
                 {% endif %}
                       data-id="{{place.code}}"
                       class="bg-{{place.slug}}"
                       data-lat="{{place.latitude}}"
                       data-long="{{place.longitude}}"
                       style="visibility: hidden"
                       ></use>
              </a>
          {% endfor %}
          </g>
          {% endif %}
      </svg>
      <aside>
          {% if escola %}
              {% include 'regionalizacao/_escolas_card.html' with escola=escola %}
          {% else %}
              {% include 'regionalizacao/_etapas_card.html' with etapas=etapas current_level=current_level total=total rede=filter_form.rede.value %}
          {% endif %}
      </aside>
      </div>
    </div>
  </section>
  <section id="localidade">
      <div class="wrapper">
          <h2>Principais recursos por <em>localidade</em> em {{filter_form.year.value|default:years|unlocalize}}
          <div class="tooltip-container">
            <svg class="icon">
              <use xlink:href="{% static 'regionalizacao/img/info.svg' %}#icon"></use>
            </svg>
            <div class="tooltip">
              <div>
                   Essa ferramenta exibe apenas parte dos recursos direcionados aos territórios.
              </div>
            </div>
          </div>
          </h2>
          <form action="#localidade" method="get" class="query">
              <div class="form-item">
                  Visualizar por:
              </div>
              <div class="form-item">
                  {{ filter_form.localidade }}
              </div>
              <div class="form-item switch">
                  <input type="checkbox" name="" id="localidade-order">
                  <label for="localidade-order">Ordem Alfabética</label>
                  <label for="localidade-order">Ordem Crescente</label>
              </div>
              <input class="submit" type="submit" value="Filtrar" name="go">
          </form>
          <div class="barchart">
              {% with max_location=locations|dictsort:'total'|last%}
              {% for location in locations %}
                  {% widthratio location.total max_location.total 100 as percentage %}
                  <div class="bar" data-label="{{location.name}}" data-value="{{location.total|unlocalize}}" data-percentage="{{percentage}}" style="width: {{percentage}}%">
                      <div class="label">{{location.name}}</div>
                      <div class="value">R$ {{location.total|floatformat:2}}</div>
                  </div>
              {% endfor %}
              {% endwith %}
          </div>
      </div>
  </section>
{% endblock %}
